<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Görev Takip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* === GENEL TEMA === */
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(120deg, #2b2b2b, #3f3f3f, #1a1a1a);
            color: #e5e5e5;
            margin: 0;
            min-height: 100vh;
        }

        /* === HEADER === */
        header {
            background: linear-gradient(90deg, #333, #4d4d4d, #262626);
            backdrop-filter: blur(6px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.4);
            /* fırçalanmış metal efekti */
            background-image: repeating-linear-gradient( 90deg, rgba(255,255,255,0.05) 0px, rgba(255,255,255,0.05) 1px, transparent 2px, transparent 4px );
        }

        /* === BUTONLAR === */
        .btn {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, #d1d1d1, #8f8f8f, #f2f2f2);
            background-image: repeating-linear-gradient( 45deg, rgba(255,255,255,0.15) 0px, rgba(255,255,255,0.15) 1px, transparent 2px, transparent 6px );
            color: #1f1f1f;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
        }

            /* krom yansıma efekti */
            .btn::before {
                content: "";
                position: absolute;
                top: -50%;
                left: -50%;
                width: 200%;
                height: 200%;
                background: linear-gradient( 120deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 40%, rgba(255,255,255,0) 60% );
                transform: rotate(25deg);
                transition: all 0.5s ease;
                opacity: 0;
            }

            .btn:hover::before {
                left: -30%;
                opacity: 1;
            }

            .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 14px rgba(0,0,0,0.4);
                background: linear-gradient(135deg, #e6e6e6, #b5b5b5, #ffffff);
            }


        .panel {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(8px);
            border-radius: 8px;
            padding: 1rem;
        }

        /* === MASAÜSTÜ KOLONLARI === */
        .grid {
            display: grid;
            grid-template-columns: repeat(4,1fr);
            gap: 1rem;
        }

        .column {
            display: flex;
            flex-direction: column;
            border-radius: 12px;
            padding: 1rem;
            overflow: hidden;
            height: 700px; /* masaüstünde sabit yükseklik */
        }

        /* Kolon Renkleri */
        #col-todo {
            background: linear-gradient(135deg,rgba(37,99,235,0.6),rgba(59,130,246,0.6));
        }

        #col-progress {
            background: linear-gradient(135deg,rgba(217,119,6,0.6),rgba(245,158,11,0.6));
        }

        #col-done {
            background: linear-gradient(135deg,rgba(5,150,105,0.6),rgba(16,185,129,0.6));
        }

        #col-archive {
            background: linear-gradient(135deg,#b91c1c,#ef4444);
        }

        .column-header {
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            color: #fff;
            margin-bottom: .5rem;
        }

        .list {
            flex-grow: 1;
            overflow-y: auto; /* masaüstünde kartlar scroll */
            padding-right: 4px;
        }

        /* === SAYFALAMA === */
        .pager {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }

            .pager button {
                background: rgba(255,255,255,0.2);
                color: #fff;
                padding: 4px 8px;
                border-radius: 4px;
                cursor: pointer;
                border: none;
            }

                .pager button.hidden {
                    display: none;
                }

        /* === KARTLAR === */
        .task {
            background: rgba(255,255,255,0.95);
            color: #111;
            border-radius: 8px;
            padding: 12px;
            position: relative;
            border: 2px solid transparent;
            transition: transform .25s ease, box-shadow .4s ease, border-color .3s ease;
            cursor: default;
        }

            .task:hover {
                cursor: pointer;
                transform: translateY(-3px);
                border-color: #3b82f6;
                box-shadow: -4px -4px 12px rgba(255,0,128,0.8), 4px -4px 12px rgba(59,130,246,0.8), -4px 4px 12px rgba(16,185,129,0.8), 4px 4px 12px rgba(245,158,11,0.8);
            }

            .task.dragging {
                opacity: .5;
            }

            .task.archived * {
                text-decoration: line-through;
                color: #6b7280;
            }

        /* === KART BUTONLARI === */
        .btn-box {
            position: absolute;
            top: 6px;
            right: 6px;
            display: flex;
            gap: 6px;
        }

        .edit, .del {
            font-size: .8rem;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
        }

        .edit {
            background: rgba(59,130,246,0.1);
            color: #2563eb;
        }

        .del {
            background: rgba(220,38,38,0.1);
            color: #dc2626;
        }

        /* === METİN === */
        .title-text {
            font-weight: 600;
            font-size: 1rem;
        }

        .desc-text {
            font-size: .85rem;
            color: #374151;
        }

        .date-text {
            font-size: .75rem;
            color: #6b7280;
            text-align: right;
            margin-top: 4px;
        }

        /* === MODAL === */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .modal-content {
            background: #1e293b;
            padding: 1.5rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;

        }

            .modal-content h2 {
                font-size: 1.25rem;
                margin-bottom: 1rem;
                color: #fff;
            }

            .modal-content input,
            .modal-content textarea {
                width: 100%;
                padding: 0.5rem;
                margin-bottom: 1rem;
                border-radius: 6px;
                border: none;
                outline: none;
                background: #f9fafb; /* açık gri / beyaz arka plan */
                color: #111; /* siyah yazı */
            }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        /* === MOBİL İÇİN AKORDEON === */
        @media(max-width:768px) {
            .grid {
                grid-template-columns: 1fr;
                grid-auto-rows: auto;
            }

            .column {
                height: auto;
                padding: 0;
                border-radius: 8px;
                overflow: visible;
            }

            .column-header {
                background: rgba(0,0,0,0.25);
                padding: .75rem 1rem;
                margin: 0;
                cursor: pointer;
            }

            .column .list {
                display: none;
                max-height: 0;
                overflow: hidden;
                padding: 0 .5rem;
                transition: max-height .3s ease;
            }

            .column.open .list {
                display: block;
                max-height: 60vh;
                overflow-y: auto;
                padding: .5rem;
            }

            .column .pager {
                display: none;
            }

            .column.open .pager {
                display: flex;
                padding: .5rem;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1 class="text-xl font-bold text-white">🚀 Görev Takip</h1>
        <div class="flex gap-2">
            <button id="users-btn" class="btn hidden bg-yellow-600">Kullanıcılar</button>
            <button id="logout-btn" class="btn bg-red-600">Çıkış Yap</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 space-y-6">
        <!-- Filtre + Yeni İş -->
        <div class="panel flex flex-wrap gap-4 items-center">
            <input id="search-input" class="text-black px-3 py-2 rounded w-48" placeholder="Ara...">
            <input id="start-date" type="date" class="text-black px-3 py-2 rounded w-40">
            <input id="end-date" type="date" class="text-black px-3 py-2 rounded w-40">
            <button id="apply-filter" class="btn bg-blue-600">Filtrele</button>
            <button id="new-task-btn" class="btn bg-green-600 hover:bg-green-700">+ Yeni İş</button>
        </div>

        <!-- Sütunlar -->
        <div class="grid">
            <div class="column" id="col-todo" data-status="todo">
                <div class="column-header">📝 Yapılacaklar</div>
                <div class="list space-y-3"></div>
                <div class="pager"><button class="prev hidden">← Önceki</button><button class="next hidden">Sonraki →</button></div>
            </div>
            <div class="column" id="col-progress" data-status="progress">
                <div class="column-header">⚙️ Şu An Yaptıklarım</div>
                <div class="list space-y-3"></div>
                <div class="pager"><button class="prev hidden">← Önceki</button><button class="next hidden">Sonraki →</button></div>
            </div>
            <div class="column" id="col-done" data-status="done">
                <div class="column-header">✅ Bitenler</div>
                <div class="list space-y-3"></div>
                <div class="pager"><button class="prev hidden">← Önceki</button><button class="next hidden">Sonraki →</button></div>
            </div>
            <div class="column" id="col-archive" data-status="archive">
                <div class="column-header">📦 Arşiv</div>
                <div class="list space-y-3"></div>
                <div class="pager"><button class="prev hidden">← Önceki</button><button class="next hidden">Sonraki →</button></div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="task-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2>Yeni İş Ekle</h2>
            <input type="text" id="modal-task-title" placeholder="Görev başlığı...">
            <textarea id="modal-task-desc" rows="4" placeholder="Açıklama..."></textarea>
            <div class="modal-actions">
                <button id="close-modal" class="btn bg-gray-600">Kapat</button>
                <button id="save-task" class="btn bg-green-600">Kaydet</button>
            </div>
        </div>
    </div>

    <template id="tpl">
        <div class="task" draggable="true">
            <div class="btn-box">
                <button class="edit">✏</button>
                <button class="del">✖</button>
            </div>
            <br />
            <div class="title-text"></div>
            <div class="desc-text"></div>
            <div class="date-text"></div>
        </div>
    </template>

    <script>
        let filters = { search: '', startDate: '', endDate: '' };
        const state = {
            todo: { page: 1, total: 0, pageSize: 6 },
            progress: { page: 1, total: 0, pageSize: 6 },
            done: { page: 1, total: 0, pageSize: 6 },
            archive: { page: 1, total: 0, pageSize: 6 }
        };

        const api = {
            listByStatus: (status, page) => {
                const params = new URLSearchParams();
                params.append('status', status);
                params.append('page', page);
                params.append('pageSize', state[status].pageSize);
                if (filters.search) params.append('search', filters.search);
                if (filters.startDate) params.append('startDate', filters.startDate);
                if (filters.endDate) params.append('endDate', filters.endDate);
                return fetch(`/api/todos/by-status?${params}`).then(r => r.json());
            },
            add: t => fetch('/api/todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Text: `${t.title}||${t.desc}`, Status: 'todo' })
            }).then(r => r.json()),
            upd: (id, p) => fetch(`/api/todos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(p)
            }),
            del: id => fetch(`/api/todos/${id}`, { method: 'DELETE' })
        };

        function formatDate(iso) {
            return iso ? new Date(iso).toLocaleString('tr-TR', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit'
            }) : '';
        }
        function parseText(txt) {
            const [t, ...r] = txt.split('||');
            return { title: t, desc: r.join('||') };
        }

        const tpl = document.getElementById('tpl');

        async function renderColumn(status) {
            const res = await api.listByStatus(status, state[status].page);
            const { items, total, page, pageSize } = res;
            state[status].total = total;
            state[status].page = page;

            const col = document.querySelector(`#col-${status} .list`);
            col.innerHTML = '';

            items.forEach(t => {
                const el = tpl.content.firstElementChild.cloneNode(true);
                const parts = parseText(t.text);
                el.dataset.id = t.id;
                el.dataset.status = t.status;
                if (t.status === 'archive') el.classList.add('archived');

                el.querySelector('.title-text').textContent = parts.title || '(Başlık yok)';
                el.querySelector('.desc-text').textContent = parts.desc || '';
                el.querySelector('.date-text').textContent = t.createdAt ? `🗓 ${formatDate(t.createdAt)}` : '';

                el.querySelector('.del').addEventListener('click', async () => {
                    const r = await Swal.fire({ title: 'Sil?', icon: 'warning', showCancelButton: true });
                    if (r.isConfirmed) { await api.del(t.id); renderColumn(status); }
                });

                el.querySelector('.edit').addEventListener('click', async () => {
                    const { value: fv } = await Swal.fire({
                        title: 'Görevi Düzenle',
                        html: `<input id="swal-title" class="swal2-input" value="${parts.title || ''}">
                           <textarea id="swal-desc" class="swal2-textarea">${parts.desc || ''}</textarea>`,
                        showCancelButton: true,
                        preConfirm: () => ({
                            title: document.getElementById('swal-title').value.trim(),
                            desc: document.getElementById('swal-desc').value.trim()
                        })
                    });
                    if (fv) { await api.upd(t.id, { Text: `${fv.title}||${fv.desc}`, Status: t.status }); renderColumn(status); }
                });

                el.addEventListener('dragstart', () => el.classList.add('dragging'));
                el.addEventListener('dragend', () => el.classList.remove('dragging'));

                el.addEventListener('click', async (e) => {
                    if (e.target.classList.contains('edit') || e.target.classList.contains('del')) return;
                    if (window.innerWidth < 768) {
                        const { value: newSt } = await Swal.fire({
                            title: 'Görevi Taşı',
                            input: 'select',
                            inputOptions: {
                                todo: '📝 Yapılacaklar',
                                progress: '⚙️ Şu An Yaptıklarım',
                                done: '✅ Bitenler',
                                archive: '📦 Arşiv'
                            },
                            inputValue: t.status || 'todo',
                            showCancelButton: true
                        });
                        if (newSt) {
                            await api.upd(t.id, { Status: newSt });
                            Swal.fire('Taşındı', 'Görev güncellendi', 'success');
                            render();
                        }
                    }
                });

                col.appendChild(el);
            });

            const pager = document.querySelector(`#col-${status} .pager`);
            const prev = pager.querySelector('.prev');
            const next = pager.querySelector('.next');
            prev.classList.toggle('hidden', page <= 1);
            next.classList.toggle('hidden', page * pageSize >= total);
            prev.onclick = () => { state[status].page--; renderColumn(status); }
            next.onclick = () => { state[status].page++; renderColumn(status); }
        }

        function render() {
            renderColumn('todo');
            renderColumn('progress');
            renderColumn('done');
            renderColumn('archive');
        }

        /* Filtre */
        document.getElementById('apply-filter').addEventListener('click', () => {
            filters.search = document.getElementById('search-input').value.trim();
            filters.startDate = document.getElementById('start-date').value;
            filters.endDate = document.getElementById('end-date').value;
            Object.keys(state).forEach(k => state[k].page = 1);
            render();
        });

        /* Drag & Drop */
        document.querySelectorAll('.column').forEach(col => {
            col.addEventListener('dragover', e => { e.preventDefault(); col.classList.add('drag-over'); });
            col.addEventListener('dragleave', () => col.classList.remove('drag-over'));
            col.addEventListener('drop', async () => {
                const dragged = document.querySelector('.dragging');
                if (dragged) {
                    const id = dragged.dataset.id;
                    const newSt = col.dataset.status;
                    await api.upd(id, { Status: newSt });
                    render();
                }
            });
        });

        async function checkAuth() {
            const res = await fetch("/api/auth/me");
            if (res.status === 401) {
                window.location.href = "/login.html";
            }
        }
        checkAuth();

        /* Logout */
        document.getElementById('logout-btn').addEventListener('click', async () => {
            const res = await fetch('/api/auth/logout', { method: 'POST' });
            if (res.ok) Swal.fire('Çıkış yapıldı', 'Yeniden giriş yapınız', 'info').then(() => location.href = '/login.html');
        });

        /* Rol Kontrolü */
        async function checkRole() {
            const res = await fetch('/api/auth/me');
            if (res.ok) {
                const u = await res.json();
                if (u.role === 'Admin') document.getElementById('users-btn').classList.remove('hidden');
            }
        }
        document.getElementById('users-btn').addEventListener('click', () => location.href = '/users.html');

        /* Modal Aç/Kapat */
        const modal = document.getElementById('task-modal');
        document.getElementById('new-task-btn').addEventListener('click', () => {
            document.getElementById('modal-task-title').value = '';
            document.getElementById('modal-task-desc').value = '';
            modal.style.display = 'flex';
        });
        document.getElementById('close-modal').addEventListener('click', () => modal.style.display = 'none');

        document.getElementById('save-task').addEventListener('click', async () => {
            const title = document.getElementById('modal-task-title').value.trim();
            const desc = document.getElementById('modal-task-desc').value.trim();
            if (!title) {
                Swal.fire('Uyarı', 'Başlık giriniz', 'warning');
                return;
            }
            await api.add({ title, desc });
            modal.style.display = 'none';
            state.todo.page = 1;
            render();
        });

        /* Accordion Setup */
        function setupAccordion() {
            const isMobile = window.innerWidth < 768;
            document.querySelectorAll('.column-header').forEach(header => {
                const newHeader = header.cloneNode(true);
                header.parentNode.replaceChild(newHeader, header);
            });
            if (isMobile) {
                document.querySelectorAll('.column-header').forEach(header => {
                    header.addEventListener('click', () => header.parentElement.classList.toggle('open'));
                });
            } else {
                document.querySelectorAll('.column').forEach(col => col.classList.remove('open'));
            }
        }

        setupAccordion();
        window.addEventListener('resize', setupAccordion);

        checkRole();
        render();
    </script>
</body>
</html>
